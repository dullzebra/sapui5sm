<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta charset="UTF-8">

        <title>Просмотр товара</title>

        <style type="text/css">
            /* все элементы VBox'a с шириной во всю строку */
            #myView2--idVBox > div {
                width: 100%;
            }
        </style>

        <!-- src="https://openui5.hana.ondemand.com/resources/sap-ui-core.js" -->

        <script
            id="sap-ui-bootstrap"
            type="text/javascript"
            src="https://sapui5.hana.ondemand.com/sdk/resources/sap-ui-core.js"
            data-sap-ui-theme="sap_bluecrystal"
            data-sap-ui-libs="sap.m, sap.ui.layout"
            data-sap-ui-xx-bindingSyntax="complex"
        >
        </script>

        <!-- Страница выбора категории -->
        <script id="view1" type="sapui5/xmlview" >
            <mvc:View
                controllerName="local.controller.Master"
                xmlns="sap.m"
                xmlns:sap.ui.core="sap.ui.core"
                xmlns:mvc="sap.ui.core.mvc" >
                <Page id="page" title="Выбор категории" showFooter="true">
                    <headerContent>
                        <Button icon="sap-icon://cart" tooltip="Добавить в корзину" />
                    </headerContent>
                    <subHeader>
                        <Toolbar id="searchBar" >
                            <content>
                                <SearchField id="searchField" width="100%" placeholder="Поиск ..." showRefreshButton="true"  search="onSearch"  />
                            </content>
                        </Toolbar>
                    </subHeader>
                    <content>
                        <List id="categoryList" headerText="" noDataText="Нет данных">
                            <items>
                                <StandardListItem type="Active" counter="5" title="Категория 1" press=".onItemPress"/>
                                <StandardListItem type="Active" counter="2" title="Категория 2" press=".onItemPress"/>
                                <StandardListItem type="Active" counter="4" title="Категория 3" press=".onItemPress"/>
                                <StandardListItem type="Active" counter="7" title="Категория 4" press=".onItemPress"/>
                            </items>
                        </List>
                    </content>
                    <footer>
                        <Toolbar>
						 <ToolbarSpacer />
						<Button text="Добавить категорию" icon="sap-icon://add" press=".onAddCategoryPress" />
                        </Toolbar>
                    </footer>
                </Page>
            </mvc:View>
        </script>

        <!-- Детальная страница -->
        <script id="view2" type="sapui5/xmlview">
            <mvc:View
                controllerName="local.controller.Detail"
                xmlns="sap.m"
                xmlns:sap.ui.core="sap.ui.core"
                xmlns:mvc="sap.ui.core.mvc" >
                <Page id="page" navButtonPress="handleNavButtonPress" title="{Name}" showNavButton="{device>/isPhone}">
                    <content>
                        <ObjectHeader title="Laptop Case" number="78.99" numberUnit="EUR" introActive="false" titleActive="false" iconActive="false">
                            <attributes>
                                <ObjectAttribute text="Red point stories" active="false" />
                                <ObjectAttribute text="Laptop Case with many room for pencils and other stationaries" active="false" />
                                <ObjectAttribute text="789g" active="false" />
                            </attributes>
                            <firstStatus>
                                <ObjectStatus text="Доступен" state="Success" />
                            </firstStatus>
                        </ObjectHeader>
                        <VBox id="idVBox" direction="Column" alignItems="Center">
                            <items>
                                <IconTabBar
                                    expanded="true"
                                    width="100%"
                                    id="idIconTabBar"
                                    class="sapUiResponsiveContentPadding">
                                    <items>                                      
									 <IconTabFilter
                                        icon="sap-icon://product"
                                        iconColor="Positive"
                                        design="Horizontal"                                       
                                        text="Продукты"
                                       >
										 <content>
	
										 <Table selectionmode= "multi">								
													<headerToolbar>
													  <Toolbar>
														<Title text="Продукты" level="H2" />
														<ToolbarSpacer />
														<Button
														  icon="sap-icon://settings"
														  press="handleButtonPress" />
														<Button
														  icon="sap-icon://person-placeholder"
														  press="handleButtonPress" />
														<Button
														  icon="sap-icon://drop-down-list"
														  press="handleButtonPress" />
													  </Toolbar>
													</headerToolbar>
													<infoToolbar>
													  <Toolbar
														active="true"
														press="handleInfobarPress" >
														<Label text="This is the info bar" />
													  </Toolbar>
													</infoToolbar>
													<columns>
														<Column width="2em"></Column>
														<Column width="48px" ></Column>
														<Column width="100%"></Column>																	
													</columns>						
													<items>
														<ColumnListItem type="Active" press=".onProductRowPress">	
															<cells>
																<CheckBox text="" select="onProductSelect" />
																<Image  width="48px" src = "https://sapui5.hana.ondemand.com/sdk/test-resources/sap/ui/demokit/explored/img/HT-6100.jpg" />
																<ObjectIdentifier title="Power Projector 4713" text="1239102" />
															</cells>
														</ColumnListItem>														
														<ColumnListItem type="Active" press=".onProductRowPress">	
															<cells>
																<CheckBox text="" select="onProductSelect" />			
																<Image  width="48px" src = "https://sapui5.hana.ondemand.com/sdk/test-resources/sap/ui/demokit/explored/img/HT-1071.jpg" />
																<ObjectIdentifier title="Gladiator MX" text="2212-121-828" />
															</cells>
														</ColumnListItem>		
														<ColumnListItem type="Active" press=".onProductRowPress">	
															<cells>
																<CheckBox text="" select="onProductSelect" />			
																<Image  width="48px" src = "https://sapui5.hana.ondemand.com/sdk/test-resources/sap/ui/demokit/explored/img/HT-1072.jpg" />
																<ObjectIdentifier title="Hurricane GX" text="K47322.1" />
															</cells>
														</ColumnListItem>		
														<ColumnListItem type="Active" press=".onProductRowPress">		
															<cells>
																<CheckBox text="" select="onProductSelect" />			
																<Image  width="48px" src = "https://sapui5.hana.ondemand.com/sdk/test-resources/sap/ui/demokit/explored/img/HT-1112.jpg" />
																<ObjectIdentifier title="Webcam" text="22134T" />
															</cells>
														</ColumnListItem>

													</items>
												</Table>
											</content>
										</IconTabFilter>
										<IconTabFilter
                                        icon="sap-icon://begin"
                                        iconColor="Positive"
                                        design="Horizontal"
                                        count="7 из 14"
                                        text="Confirm Ok"
                                        key="Ok" />
                                      <IconTabSeparator icon="sap-icon://open-command-field" />
                                      <IconTabFilter
                                        icon="sap-icon://compare"
                                        iconColor="Critical"
                                        design="Horizontal"
                                        count="5 из 14"
                                        text="Check Heavys"
                                        key="Heavy" />
                                      <IconTabSeparator icon="sap-icon://open-command-field" />
                                      <IconTabFilter
                                        icon="sap-icon://inventory"
                                        iconColor="Negative"
                                        design="Horizontal"
                                        count="2 из 14"
                                        text="Claim Overweights"
                                        key="Overweight" />
                                    </items>
                                   
                                </IconTabBar>
								
                            </items>
                        </VBox>

                    </content>
                    <footer>
                        <Toolbar>
                            <content>
                                <ToolbarSpacer />
								
                                <Button text="Добавить в корзину" icon="sap-icon://add" /> 
								
                            </content>
                        </Toolbar>
                    </footer>
                </Page>
            </mvc:View>
        </script>

        <!-- Подключение страниц -->
        <script>
            // Controller definition 4 Master
            sap.ui.controller("local.controller.Master", {               
				onSearch: function(oEvent){
					var q = oEvent.getParameter("query");
					//alert(oEvent.getSource());					
					var oFilter =  new sap.ui.model.Filter("title", sap.ui.model.FilterOperator.Contains, q);  					
					  var oList = this.getView().byId("categoryList"); 
					  var listBinding = oList.getBinding("items");  
					  listBinding.filter([oFilter], "Application");  
				},
				
				onItemPress: function(oEvent) {
                 // alert('Нажат элемент '+oEvent.getSource().getTitle());						
					this.openEditDialog(oEvent);
                },  
				openEditDialog: function(oEvent){					
					var oItem = oEvent.getSource();

					//Edit Category Form	
					var oEditCategoryForm  = this.createCategoryForm(oItem.getTitle(), oItem.getCounter());		
										
					var oDialog =  this.createCategoryDialog(
									"Редактирование", 
									oEditCategoryForm, 
									function(title, counter){
											oItem.setTitle(title);
											oItem.setCounter(oNumberFormat.parse(counter));
									});
					
					oDialog.open();                
				},
                onAddCategoryPress: function(oEvent) {
					 //New Category Form	
					var oNewCategoryForm  = this.createCategoryForm("{title}", "{counter}")					 
									 
					 var oList = this.getView().byId("categoryList"); 
					 var itemHandler = this.onItemPress.bind(this);
					 
					 var oDialog =  this.createCategoryDialog(
									"Новая категория", 
									oNewCategoryForm, 
									function(title, counter){
										var oItem = new sap.m.ObjectListItem({
											counter: oNumberFormat.parse(counter),
											title: title,											
											type:  sap.m.ListType.Active,
											press: itemHandler,
										  });
										oList.addItem(oItem);
									});				 
					
					oDialog.open();

                },
				createCategoryForm: function(titleVal, counterVal){
					/* если при закрытии диалога объект sap.ui.layout.form.SimpleForm удаляется сам,
						то надо его при каждом вызове создвать, 
						а если не удаляется, то здесь надо переделать на showCategoryForm,
						которая  проверяет, есть ли уже форма, и тогда заполняет переданными данными, 
						или создает ее при первом вызове.
					*/
					var title = titleVal ? titleVal : "";
					var counter  = counterVal ? counterVal : 0;
					
					return new sap.ui.layout.form.SimpleForm({				
						  content:[					  
							  new sap.m.Label({text : "Заголовок", design : "Bold", textAlign : "Begin"}),
							  new sap.m.Input({value : title}),
							  new sap.m.Label({text : "Число", design : "Bold", textAlign : "Begin"}),
							  new sap.m.Input({type : "Number", value : counter}),				  
						  ]
					});											
				},
				
				createCategoryDialog: function(headerText, form, saveActionFunc){
					/*
					здесь то же самое - если объект диалога при закрытии сам не удаляется, то лучше создать один и вызывать потом с новым контентом. сейчас создается каждый раз
					*/
					
					var dialog =  new sap.m.Dialog({  
						  title : headerText || "", 
						  content : form,
						  buttons : [
							  new sap.m.Button({  
								  type : sap.m.ButtonType.Accept,
								  text: "Сохранить",
								  press : function(){									
									var content  = form.getContent();
									var counter =  content[3].getValue();
									//content[1],content[3] - так не очень хорошо, не нашла как сделать по-человечнее
									var title =  content[1].getValue();
									
									if (title == "" ){					
										sap.m.MessageToast.show("Введите название категории",{
											of:content[1]
										});
									}else if (counter == "" ){					
										sap.m.MessageToast.show("Введите количество",{
											of:content[3]
										});
									}else{									
										if (saveActionFunc && (typeof saveActionFunc == 'function')){
											saveActionFunc(title, counter);
											dialog.close();
										}											
									 };
									 
								  },   
							  }),
							  new sap.m.Button({  
								  type : sap.m.ButtonType.Reject, 
								  text: "Отменить",
								  press : function(){
									dialog.close();
								  },
							  }), 
							  
							]
					}) ;
					
					return dialog;
				}
            });

            // Controller definition 4 Detail
            sap.ui.controller("local.controller.Detail", {
				onProductRowPress: function(oEvent){
					oEvent.preventDefault();
					console.log(oEvent)
					//опять не знаю, как обратитья именно к чекбоксу, а не по порядку элементов
					var chbox = oEvent.getSource().getCells()[0];
					chbox.setSelected(!chbox.getSelected());
				}
            });

            var splitApp = new sap.m.SplitApp({
                masterPages: [sap.ui.xmlview("myView1", {viewContent:jQuery('#view1').html()})],
                detailPages: [sap.ui.xmlview("myView2", {viewContent:jQuery('#view2').html()})]
            });

            var shell = sap.m.Shell({
                showLogout:false,
                app:splitApp
            })
			
			//Common Helpers
			jQuery.sap.require("sap.m.MessageToast");
			jQuery.sap.require("sap.ui.core.format.NumberFormat");
			
			var oNumberFormat = sap.ui.core.format.NumberFormat.getIntegerInstance({
			  maxFractionDigits: 0,
			  groupingEnabled: false
			});
			
            // oView.setModel(new sap.ui.model.json.JSONModel("https://openui5.hana.ondemand.com/test-resources/sap/ui/demokit/explored/products.json"));

            shell.placeAt('content');
        </script>

    </head>

    <body class="sapUiBody" role="application">
        <div id="content"></div>
    </body>
</html>
